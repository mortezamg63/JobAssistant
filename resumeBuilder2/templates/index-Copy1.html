<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <title>Resume Section Editor</title>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
      max-width: 800px;
      margin: 40px auto;
      color: #333;
      line-height: 1.5;
    }
    h1 {
      font-size: 2rem;
      margin-bottom: 1rem;
    }
    #upload-area {
      margin-bottom: 2rem;
    }
    #fileInput {
      display: block;
      margin-bottom: 0.5rem;
    }
    #uploadBtn {
      padding: 0.5rem 1rem;
      font-size: 1rem;
      border: 1px solid #888;
      background: #f7f7f7;
      border-radius: 4px;
      cursor: pointer;
    }
    #uploadBtn:hover {
      background: #eee;
    }
    #status {
      margin-top: 0.5rem;
      font-size: 0.9rem;
      color: #555;
    }

    .main-section {
      border: 1px solid #ccc;
      border-radius: 6px;
      padding: 1rem;
      margin-bottom: 1.5rem;
      background: #fafafa;
    }
    .main-section > h2 {
      margin: 0 0 1rem;
      font-size: 1.5rem;
      font-weight: 600;
    }
    .add-sub-btn {
      display: inline-block;
      margin-bottom: 1rem;
      padding: 0.4rem 0.8rem;
      font-size: 0.9rem;
      border: 1px dashed #888;
      background: #fff;
      color: #555;
      border-radius: 4px;
      cursor: pointer;
    }
    .add-sub-btn:hover {
      background: #f9f9f9;
    }

    .subsection {
      border: 1px solid #ddd;
      border-radius: 4px;
      padding: 0.75rem;
      margin-bottom: 1rem;
      background: #fff;
      position: relative;
    }
    .subsection > h3 {
      margin: 0 0 0.5rem;
      font-size: 1.1rem;
      font-weight: 500;
    }
    .delete-btn {
      position: absolute;
      top: 8px;
      right: 8px;
      background: none;
      border: none;
      font-size: 1rem;
      color: #c33;
      cursor: pointer;
    }
    .delete-btn:hover {
      color: #800;
    }

    .editor {
      border: 1px solid #ccc;
      border-radius: 4px;
      padding: 0.5rem;
      min-height: 100px;
      background: #fff;
    }
    .subsection button.save-btn {
      margin-top: 0.75rem;
      padding: 0.4rem 0.8rem;
      font-size: 0.9rem;
      border: 1px solid #888;
      background: #fff;
      border-radius: 4px;
      cursor: pointer;
    }
    .subsection button.save-btn:hover {
      background: #f0f0f0;
    }

    .editor ul {
      margin: 0.5rem 0 0.5rem 1.25rem;
    }
    .editor p {
      margin: 0.5rem 0;
    }
  </style>
</head>
<body>
  <h1>Resume Section Editor</h1>

  <div id="upload-area">
    <input type="file" id="fileInput" accept=".pdf,.doc,.docx" />
    <button id="uploadBtn">Upload &amp; Parse</button>
    <div id="status"></div>
  </div>

  <div id="sections"></div>

  <script>
    const fileInput   = document.getElementById('fileInput');
    const uploadBtn   = document.getElementById('uploadBtn');
    const statusDiv   = document.getElementById('status');
    const sectionsDiv = document.getElementById('sections');

    uploadBtn.addEventListener('click', async () => {
      const file = fileInput.files[0];
      if (!file) return alert('Select a PDF or Word file first.');
      statusDiv.textContent = 'Uploading…';
      const form = new FormData();
      form.append('file', file);

      try {
        const res = await fetch('/upload', { method: 'POST', body: form });
        if (!res.ok) throw await res.json();
        const { sections } = await res.json();
        statusDiv.textContent = `Parsed ${sections.length} subsections.`;
        renderSections(sections);
      } catch (e) {
        console.error(e);
        statusDiv.textContent = `Error: ${e.error||e.message}`;
      }
    });

    async function fetchSections() {
      statusDiv.textContent = 'Loading sections…';
      try {
        const res = await fetch('/sections');
        const sections = await res.json();
        statusDiv.textContent = `Loaded ${sections.length} subsections.`;
        renderSections(sections);
      } catch (e) {
        console.error(e);
        statusDiv.textContent = 'Failed to load sections.';
      }
    }

    function renderSections(sections) {
      // Group by main section
      const bySection = {};
      sections.forEach(sec => {
        if (!bySection[sec.section]) bySection[sec.section] = [];
        bySection[sec.section].push(sec);
      });

      sectionsDiv.innerHTML = '';
      Object.entries(bySection).forEach(([sectionName, subs]) => {
        const main = document.createElement('div');
        main.className = 'main-section';

        const h2 = document.createElement('h2');
        h2.textContent = sectionName;
        main.appendChild(h2);

        // Add Subsection button
        const addBtn = document.createElement('button');
        addBtn.className = 'add-sub-btn';
        addBtn.textContent = '+ Add Subsection';
        addBtn.onclick = async () => {
          const subtitle = prompt('Enter subtitle for new item in "'+sectionName+'":');
          if (!subtitle) return;
          // create with empty HTML
          const payload = { section: sectionName, subtitle, html: '' };
          const resp = await fetch('/sections', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
          });
          if (!resp.ok) {
            const err = await resp.json();
            return alert('Error: '+(err.error||err.message));
          }
          const { id } = await resp.json();
          await fetchSections();
        };
        main.appendChild(addBtn);

        // Render each subsection
        subs.forEach(sec => {
          const sub = document.createElement('div');
          sub.className = 'subsection';

          const del = document.createElement('button');
          del.className = 'delete-btn';
          del.innerHTML = '🗑️';
          del.title = 'Delete this subsection';
          del.onclick = async () => {
            if (!confirm('Delete "'+sec.subtitle+'"?')) return;
            const resp = await fetch(`/sections/${sec.id}`, { method: 'DELETE' });
            if (!resp.ok) {
              const err = await resp.json();
              return alert('Error: '+(err.error||err.message));
            }
            await fetchSections();
          };
          sub.appendChild(del);

          const h3 = document.createElement('h3');
          h3.textContent = sec.subtitle;
          sub.appendChild(h3);

          const editor = document.createElement('div');
          editor.className = 'editor';
          editor.contentEditable = 'true';
          editor.innerHTML = sec.html;
          sub.appendChild(editor);

          const save = document.createElement('button');
          save.className = 'save-btn';
          save.textContent = 'Save';
          save.onclick = async () => {
            save.disabled = true;
            const payload = { html: editor.innerHTML };
            const resp = await fetch(`/sections/${sec.id}`, {
              method: 'PUT',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify(payload)
            });
            if (!resp.ok) {
              const err = await resp.json();
              alert('Error: '+(err.error||err.message));
            } else {
              alert('Saved!');
            }
            save.disabled = false;
          };
          sub.appendChild(save);

          main.appendChild(sub);
        });

        sectionsDiv.appendChild(main);
      });
    }

    window.addEventListener('DOMContentLoaded', fetchSections);
  </script>
</body>
</html>
